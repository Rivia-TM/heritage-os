<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Héritage OS</title>
  <link rel="stylesheet" href="/css/app.css?v=1" />
</head>
<body>
  <div class="page">
    <div class="bg-glow"></div>

    <div class="shell">
      <div class="logo">
        <img src="/assets/logo.png" alt="Héritage" onerror="this.style.display='none'">
      </div>

      <div class="hero">Connectez-vous<br>pour accéder à votre espace.</div>

      <div class="card">
        <div id="stepEmail">
          <div class="field">
            <input id="email" type="email" autocomplete="email" placeholder="Adresse e-mail" inputmode="email" />
            <button class="btn-arrow" id="nextBtn" aria-label="Continuer">→</button>
          </div>
        </div>

        <div id="stepPass" style="display:none">
          <div class="field">
            <input id="password" type="password" autocomplete="current-password" placeholder="Mot de passe" />
            <button class="btn-arrow" id="loginBtn" aria-label="Se connecter">→</button>
          </div>
          <div class="actions"><a href="#" id="backEmail">Retour</a><span></span></div>
        </div>

        <div class="actions">
          <label class="chk"><input id="remember" type="checkbox" /><span>Se souvenir de moi</span></label>
          <div class="links">
            <a href="/forgot.html">Mot de passe oublié ?</a><span class="sep">|</span><a href="/signup.html">Créer un compte</a>
          </div>
        </div>

        <div class="msg" id="msg"></div>
      </div>
    </div>

    <div class="footer">
      <a href="/signup.html">Créer un compte Héritage OS</a><span class="sep">·</span><a href="/forgot.html">Mot de passe oublié ?</a>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/config.js?v=1"></script>
  <script src="/js/app.js?v=1"></script>
  <script>
    (function(){
      const {$, setMsg, makeClient} = window.HeritageApp;
      const msg = $("#msg");
      const stepEmail = $("#stepEmail");
      const stepPass = $("#stepPass");
      const email = $("#email");
      const password = $("#password");
      const remember = $("#remember");

      function showPass(){ stepEmail.style.display="none"; stepPass.style.display="block"; password.focus(); }
      function showEmail(){ stepPass.style.display="none"; stepEmail.style.display="block"; email.focus(); }

      $("#nextBtn").addEventListener("click", ()=>{
        if(!email.value.trim()){ setMsg(msg,"Entrez votre e-mail.","error"); return; }
        setMsg(msg,""); showPass();
      });
      $("#backEmail").addEventListener("click",(e)=>{ e.preventDefault(); showEmail(); });

      email.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); $("#nextBtn").click(); }});
      password.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); $("#loginBtn").click(); }});

      $("#loginBtn").addEventListener("click", async ()=>{
        setMsg(msg,"");
        const em=email.value.trim(), pw=password.value;
        if(!em){ setMsg(msg,"Entrez votre e-mail.","error"); showEmail(); return; }
        if(!pw){ setMsg(msg,"Entrez votre mot de passe.","error"); return; }

        const {client, error} = makeClient(remember.checked);
        if(error || !client){ setMsg(msg,"Configuration Supabase manquante (URL / ANON KEY).","error"); return; }

        $("#loginBtn").disabled=true;
        try{
          const {data, error:err} = await client.auth.signInWithPassword({ email: em, password: pw });
          if(err){ setMsg(msg,"Identifiants incorrects.","error"); return; }
          if(data?.session) window.location.href="/espace/";
          else setMsg(msg,"Connexion impossible. Réessayez.","error");
        } finally { $("#loginBtn").disabled=false; }
      });

      (async ()=>{
        const {client, error} = makeClient(true);
        if(error || !client) return;
        const {data} = await client.auth.getSession();
        if(data?.session) window.location.href="/espace/";
      })();
    })();
  </script>
</body>
</html>
