<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HERITAGE OS • Supabase login test</title>

  <!-- CDN officiel pratique -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: system-ui, -apple-system, sans-serif; background:#0e0e0e; color:#fff; padding:32px; }
    .box { max-width: 560px; }
    input, button { width:100%; padding:12px; margin:10px 0; border-radius:10px; border:1px solid #2a2a2a; background:#141414; color:#fff; }
    button { cursor:pointer; }
    .row { display:flex; gap:10px; }
    .row button { flex:1; }
    pre { background:#111; border:1px solid #2a2a2a; padding:14px; border-radius:10px; white-space:pre-wrap; }
    .muted { color:#aaa; font-size: 14px; margin-top: 6px; }
  </style>
</head>

<body>
  <div class="box">
    <h1>Login test (Supabase)</h1>
    <div class="muted">Objectif: se connecter + lire <code>public.profiles</code> (RLS)</div>

    <input id="email" placeholder="email" autocomplete="email" />
    <input id="password" type="password" placeholder="password" autocomplete="current-password" />

    <div class="row">
      <button id="btnLogin">Login</button>
      <button id="btnLogout">Logout</button>
    </div>

    <div class="row">
      <button id="btnWho">Who am I?</button>
      <button id="btnProfile">Read my profile</button>
    </div>

    <pre id="output">Prêt.</pre>
  </div>

  <script>
    // ✅ TON projet
    const SUPABASE_URL = "https://qltdzmyfluockpadrhrk.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFsdGR6bXlmbHVvY2twYWRyaHJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMjg2MTEsImV4cCI6MjA4NTcwNDYxMX0._KtfFHRifqRctnbP_-gEx2hh7ZrU87yxXl56fOHoetA";

    const outEl = document.getElementById("output");
    function out(obj) {
      const ts = new Date().toISOString().slice(11,19);
      const line = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
      outEl.textContent = `[${ts}] ${line}`;
      console.log(obj);
    }

    try {
      // Le CDN expose window.supabase
      if (!window.supabase) throw new Error("Supabase CDN non chargé (window.supabase absent)");
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      out("JS chargé. Client Supabase initialisé.");

      async function login() {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;
        if (!email || !password) return out({ step:"login", error:"email/password manquants" });

        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) return out({ step:"login", error: error.message });
        out({ step:"login", ok:true, user: { id: data.user?.id, email: data.user?.email } });
      }

      async function logout() {
        const { error } = await supabase.auth.signOut();
        if (error) return out({ step:"logout", error: error.message });
        out({ step:"logout", ok:true });
      }

      async function whoami() {
        const { data, error } = await supabase.auth.getUser();
        if (error) return out({ step:"whoami", error: error.message });
        out({ step:"whoami", user: data.user ? { id: data.user.id, email: data.user.email } : null });
      }

      async function readProfile() {
        const { data: userData } = await supabase.auth.getUser();
        const uid = userData?.user?.id;
        if (!uid) return out({ step:"readProfile", error:"Not logged in" });

        const { data, error } = await supabase
          .from("profiles")
          .select("id, role, created_at")
          .eq("id", uid)
          .single();

        if (error) return out({ step:"readProfile", uid, error: error.message });
        out({ step:"readProfile", uid, profile: data });
      }

      // Bind boutons
      document.getElementById("btnLogin").addEventListener("click", login);
      document.getElementById("btnLogout").addEventListener("click", logout);
      document.getElementById("btnWho").addEventListener("click", whoami);
      document.getElementById("btnProfile").addEventListener("click", readProfile);

    } catch (e) {
      out({ fatal: true, error: e.message });
    }
  </script>
</body>
</html>
