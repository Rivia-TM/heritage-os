<!doctype html><html lang="fr"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Nouveau mot de passe</title><link rel="stylesheet" href="/css/app.css?v=1"/></head>
<body><div class="page"><div class="bg-glow"></div><a class="toplink" href="/">Retour</a>
<div class="shell"><div class="card" style="text-align:left"><div class="smalltitle">HÉRITAGE</div><div class="h2">Créer un nouveau mot de passe</div>
<div class="p">Choisissez un mot de passe sécurisé.</div>
<div class="form-row"><div class="field"><input id="pw1" type="password" placeholder="Nouveau mot de passe" autocomplete="new-password"/></div>
<div class="field"><input id="pw2" type="password" placeholder="Confirmer le mot de passe" autocomplete="new-password"/></div></div>
<div class="actions" style="justify-content:flex-end;margin-top:14px"><button class="btn-arrow" id="saveBtn">→</button></div>
<div class="msg" id="msg"></div><div class="note">8+ caractères, 1 majuscule, 1 minuscule, 1 chiffre.</div></div></div></div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script><script src="/js/config.js?v=1"></script><script src="/js/app.js?v=1"></script>
<script>
(function(){
  const {$, setMsg, pwStrong, makeClient} = window.HeritageApp;
  const msg=$("#msg");
  const {client, error} = makeClient(true);

  async function hasSession(){
    if(error||!client) return false;
    const {data} = await client.auth.getSession();
    return !!data?.session;
  }

  $("#saveBtn").addEventListener("click", async ()=>{
    setMsg(msg,"");
    if(error||!client){ setMsg(msg,"Configuration Supabase manquante.","error"); return; }
    if(!await hasSession()){ setMsg(msg,"Lien invalide ou expiré. Refaites “mot de passe oublié”.","error"); return; }

    const a=$("#pw1").value, b=$("#pw2").value;
    if(!a||!b){ setMsg(msg,"Entrez et confirmez le mot de passe.","error"); return; }
    if(a!==b){ setMsg(msg,"Les mots de passe ne correspondent pas.","error"); return; }
    if(!pwStrong(a)){ setMsg(msg,"Mot de passe trop faible.","error"); return; }

    $("#saveBtn").disabled=true;
    try{
      const {error:err} = await client.auth.updateUser({password:a});
      if(err){ setMsg(msg,"Impossible de mettre à jour. Réessayez.","error"); return; }
      setMsg(msg,"Mot de passe mis à jour. Redirection...","ok");
      setTimeout(()=>location.href="/",900);
    } finally { $("#saveBtn").disabled=false; }
  });

  (async ()=>{ if(!error && client && !await hasSession()) setMsg(msg,"Lien invalide ou expiré. Refaites “mot de passe oublié”.","error"); })();
})();
</script>
</body></html>
